@model TupiJua.ViewModels.EditWorkoutPlanViewModel

@{
    ViewData["Title"] = "Editar Plano de Treino";
    var exercises = ViewBag.Exercises as List<TupiJua.Models.Exercise> ?? new List<TupiJua.Models.Exercise>();
}

<div class="container-fluid px-3 px-md-4 py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <!-- Header Card -->
            <div class="exercise-header-card mb-4">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="h3 mb-1">
                            <i class="fas fa-edit me-2 text-primary"></i>Editar Plano de Treino
                        </h1>
                        <p class="text-muted mb-0">Modifique seu plano, adicione ou remova exercícios</p>
                    </div>
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        <span class="d-none d-sm-inline">Voltar</span>
                    </a>
                </div>
            </div>

            <form asp-action="Edit" asp-route-id="@Model.Id" method="post" id="workoutPlanForm">
                @Html.AntiForgeryToken()
                @Html.HiddenFor(m => m.Id)

                <!-- Plan Name Card -->
                <div class="exercise-form-card mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-tag me-2"></i>
                        Nome do Plano
                    </h5>
                    <div class="form-section">
                        <label asp-for="Name" class="form-label">
                            <i class="fas fa-bookmark me-2"></i>
                            Dê um nome para seu treino
                        </label>
                        <input asp-for="Name" class="form-control form-control-lg" 
                               placeholder="Ex: Treino A - Peito e Tríceps" required />
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Use nomes descritivos para facilitar a identificação
                        </small>
                        <span asp-validation-for="Name" class="text-danger small d-block"></span>
                    </div>
                </div>

                <!-- Exercises Section -->
                <div class="exercise-form-card mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-dumbbell me-2"></i>
                        Exercícios
                    </h5>

                    <!-- Exercises Container -->
                    <div id="exercisesContainer" class="exercises-container">
                        @for (int i = 0; i < Model.Exercises.Count; i++)
                        {
                            <div class="exercise-field-card" data-index="@i" style="opacity: 1; transform: translateY(0);">
                                <input type="hidden" name="Exercises[@i].Id" value="@Model.Exercises[i].Id" />
                                
                                <div class="exercise-field-header">
                                    <div class="exercise-field-order">
                                        <i class="fas fa-grip-vertical me-2"></i>
                                        <strong>Exercício @(i + 1)</strong>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExerciseField(@i)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>

                                <div class="exercise-field-body">
                                    <!-- Exercise Selection -->
                                    <div class="form-section">
                                        <label class="form-label">
                                            <i class="fas fa-dumbbell me-2"></i>Exercício
                                        </label>
                                        <select name="Exercises[@i].ExerciseId" 
                                                class="form-select exercise-select" 
                                                id="exercise-@i"
                                                onchange="showMuscleGroups(this, @i)"
                                                required>
                                            <option value="">Selecione um exercício</option>
                                            @{
                                                var exercisesByCategory = exercises
                                                    .GroupBy(e => e.ExerciseMuscleGroups
                                                        .Where(emg => emg.IsPrimary)
                                                        .Select(emg => emg.MuscleGroup.Name)
                                                        .FirstOrDefault() ?? "Sem Categoria")
                                                    .OrderBy(g => g.Key)
                                                    .ToList();

                                                foreach (var category in exercisesByCategory)
                                                {
                                                    <optgroup label="@category.Key">
                                                        @foreach (var exercise in category.OrderBy(e => e.Name))
                                                        {
                                                            <option value="@exercise.Id" 
                                                                    selected="@(exercise.Id == Model.Exercises[i].ExerciseId)">
                                                                @exercise.Name
                                                            </option>
                                                        }
                                                    </optgroup>
                                                }
                                            }
                                        </select>
                                        <div id="muscleGroups-@i" class="mt-2 muscle-groups-container"></div>
                                    </div>

                                    <!-- Row for Sets and Reps -->
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">
                                                <i class="fas fa-redo me-2"></i>
                                                Séries
                                            </label>
                                            <div class="number-input-group">
                                                <button type="button" class="btn-number-control" onclick="decrementValue('sets-@i', 1)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input name="Exercises[@i].TargetSets" 
                                                       type="number" 
                                                       class="form-control text-center" 
                                                       id="sets-@i"
                                                       min="1" 
                                                       max="100" 
                                                       value="@Model.Exercises[i].TargetSets" 
                                                       required />
                                                <button type="button" class="btn-number-control" onclick="incrementValue('sets-@i', 1)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label">
                                                <i class="fas fa-hashtag me-2"></i>
                                                Repetições
                                            </label>
                                            <input name="Exercises[@i].TargetReps" 
                                                   type="text" 
                                                   class="form-control" 
                                                   placeholder="Ex: 12 ou 10-12"
                                                   pattern="^\d+(\s*-\s*\d+)?$"
                                                   title="Digite um número (ex: 12) ou faixa (ex: 10-12)"
                                                   value="@Model.Exercises[i].TargetReps"
                                                   required />
                                        </div>
                                    </div>

                                    <!-- Rest Time -->
                                    <div class="form-section">
                                        <label class="form-label">
                                            <i class="fas fa-stopwatch me-2"></i>
                                            Descanso entre séries
                                        </label>
                                        <div class="number-input-group">
                                            <button type="button" class="btn-number-control" onclick="decrementRestValue(@i)">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input name="Exercises[@i].RecommendedRestTime" 
                                                   type="number" 
                                                   class="form-control text-center" 
                                                   id="rest-@i"
                                                   min="0" 
                                                   max="3600" 
                                                   step="@(Model.Exercises[i].RestInMinutes ? 1 : 15)" 
                                                   value="@Model.Exercises[i].RecommendedRestTime" 
                                                   required />
                                            <button type="button" class="btn-number-control" onclick="incrementRestValue(@i)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                            <div class="input-group-text-addon" style="padding: 0; border: none; background: transparent;">
                                                <div class="btn-group btn-group-sm" role="group" style="box-shadow: none;">
                                                    <button type="button" class="btn btn-outline-primary @(Model.Exercises[i].RestInMinutes ? "" : "active")" id="restUnitSeg-@i" onclick="setRestUnitPlan(@i, false)" style="border-radius: 0.25rem 0 0 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                                        seg
                                                    </button>
                                                    <button type="button" class="btn btn-outline-primary @(Model.Exercises[i].RestInMinutes ? "active" : "")" id="restUnitMin-@i" onclick="setRestUnitPlan(@i, true)" style="border-radius: 0 0.25rem 0.25rem 0; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                                        min
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <input name="Exercises[@i].RestInMinutes" type="hidden" id="restInMinutes-@i" value="@(Model.Exercises[i].RestInMinutes ? "true" : "false")" />
                                    </div>

                                    <!-- Hidden Order Field -->
                                    <input type="hidden" name="Exercises[@i].Order" value="@(i + 1)" />
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Add Exercise Button -->
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-primary" onclick="addExerciseField()">
                            <i class="fas fa-plus me-2"></i>
                            Adicionar Exercício
                        </button>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="empty-exercise-state" style="display: @(Model.Exercises.Count == 0 ? "flex" : "none")">
                        <i class="fas fa-clipboard-list"></i>
                        <p class="mb-3">Nenhum exercício adicionado ainda</p>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="exercise-form-card">
                    <div class="form-actions">
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <i class="fas fa-save me-2"></i>Salvar Alterações
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/exercise-helpers.js"></script>
    
    <script>
        let exerciseCounter = @Model.Exercises.Count;
        const exercisesList = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(exercises.Select(e => new { 
            e.Id, 
            e.Name,
            MuscleGroups = e.ExerciseMuscleGroups.Select(emg => new {
                Name = emg.MuscleGroup.Name,
                IsPrimary = emg.IsPrimary
            })
        })));

        // Initialize muscle groups for existing exercises
        document.addEventListener('DOMContentLoaded', function() {
            @for (int i = 0; i < Model.Exercises.Count; i++)
            {
                <text>
                const select@(i) = document.getElementById('exercise-@i');
                if (select@(i) && select@(i).value) {
                    showMuscleGroups(select@(i), @i);
                }
                </text>
            }
        });

        // Add exercise field
        function addExerciseField() {
            const container = document.getElementById('exercisesContainer');
            const emptyState = document.getElementById('emptyState');
            const submitBtn = document.getElementById('submitBtn');
            
            // Hide empty state
            emptyState.style.display = 'none';
            
            // Create exercise card
            const exerciseCard = document.createElement('div');
            exerciseCard.className = 'exercise-field-card';
            exerciseCard.dataset.index = exerciseCounter;
            exerciseCard.innerHTML = `
                <input type="hidden" name="Exercises[${exerciseCounter}].Id" value="0" />
                
                <div class="exercise-field-header">
                    <div class="exercise-field-order">
                        <i class="fas fa-grip-vertical me-2"></i>
                        <strong>Exercício ${exerciseCounter + 1}</strong>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExerciseField(${exerciseCounter})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>

                <div class="exercise-field-body">
                    <!-- Exercise Selection -->
                    <div class="form-section">
                        <label class="form-label">
                            <i class="fas fa-dumbbell me-2"></i>Exercício
                        </label>
                        <select name="Exercises[${exerciseCounter}].ExerciseId" 
                                class="form-select exercise-select" 
                                id="exercise-${exerciseCounter}"
                                onchange="showMuscleGroups(this, ${exerciseCounter})"
                                required>
                            ${generateExerciseOptionsHTML(exercisesList)}
                        </select>
                        <div id="muscleGroups-${exerciseCounter}" class="mt-2 muscle-groups-container"></div>
                    </div>

                    <!-- Row for Sets and Reps -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-redo me-2"></i>
                                Séries
                            </label>
                            <div class="number-input-group">
                                <button type="button" class="btn-number-control" onclick="decrementValue('sets-${exerciseCounter}', 1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input name="Exercises[${exerciseCounter}].TargetSets" 
                                       type="number" 
                                       class="form-control text-center" 
                                       id="sets-${exerciseCounter}"
                                       min="1" 
                                       max="100" 
                                       value="3" 
                                       required />
                                <button type="button" class="btn-number-control" onclick="incrementValue('sets-${exerciseCounter}', 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-hashtag me-2"></i>
                                Repetições
                            </label>
                            <input name="Exercises[${exerciseCounter}].TargetReps" 
                                   type="text" 
                                   class="form-control" 
                                   placeholder="Ex: 12 ou 10-12"
                                   pattern="^\\d+(\\s*-\\s*\\d+)?$"
                                   title="Digite um número (ex: 12) ou faixa (ex: 10-12)"
                                   required />
                        </div>
                    </div>

                    <!-- Rest Time -->
                    <div class="form-section">
                        <label class="form-label">
                            <i class="fas fa-stopwatch me-2"></i>
                            Descanso entre séries
                        </label>
                        <div class="number-input-group">
                            <button type="button" class="btn-number-control" onclick="decrementRestValue(${exerciseCounter})">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input name="Exercises[${exerciseCounter}].RecommendedRestTime" 
                                   type="number" 
                                   class="form-control text-center" 
                                   id="rest-${exerciseCounter}"
                                   min="0" 
                                   max="3600" 
                                   step="15" 
                                   value="60" 
                                   required />
                            <button type="button" class="btn-number-control" onclick="incrementRestValue(${exerciseCounter})">
                                <i class="fas fa-plus"></i>
                            </button>
                            <div class="input-group-text-addon" style="padding: 0; border: none; background: transparent;">
                                <div class="btn-group btn-group-sm" role="group" style="box-shadow: none;">
                                    <button type="button" class="btn btn-outline-primary active" id="restUnitSeg-${exerciseCounter}" onclick="setRestUnitPlan(${exerciseCounter}, false)" style="border-radius: 0.25rem 0 0 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                        seg
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="restUnitMin-${exerciseCounter}" onclick="setRestUnitPlan(${exerciseCounter}, true)" style="border-radius: 0 0.25rem 0.25rem 0; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                        min
                                    </button>
                                </div>
                            </div>
                        </div>
                        <input name="Exercises[${exerciseCounter}].RestInMinutes" type="hidden" id="restInMinutes-${exerciseCounter}" value="false" />
                    </div>

                    <!-- Hidden Order Field -->
                    <input type="hidden" name="Exercises[${exerciseCounter}].Order" value="${exerciseCounter + 1}" />
                </div>
            `;

            container.appendChild(exerciseCard);
            
            // Animate card appearance
            setTimeout(() => {
                exerciseCard.style.opacity = '1';
                exerciseCard.style.transform = 'translateY(0)';
            }, 10);

            exerciseCounter++;
            
            // Enable submit button
            submitBtn.disabled = false;

            // Update exercise numbers
            updateExerciseNumbers();
        }

        // Remove exercise field
        function removeExerciseField(index) {
            const card = document.querySelector(`[data-index="${index}"]`);
            if (!card) return;

            // Animate removal
            card.style.opacity = '0';
            card.style.transform = 'translateX(-20px)';
            
            setTimeout(() => {
                card.remove();
                
                // Check if container is empty
                const container = document.getElementById('exercisesContainer');
                const emptyState = document.getElementById('emptyState');
                
                if (container.children.length === 0) {
                    emptyState.style.display = 'flex';
                }
                
                // Update exercise numbers and indices
                updateExerciseNumbers();
            }, 300);
        }

        // Update exercise numbers and order values
        function updateExerciseNumbers() {
            const cards = document.querySelectorAll('.exercise-field-card');
            cards.forEach((card, index) => {
                const orderSpan = card.querySelector('.exercise-field-order strong');
                orderSpan.textContent = `Exercício ${index + 1}`;
                
                const orderInput = card.querySelector('input[name*=".Order"]');
                if (orderInput) {
                    orderInput.value = index + 1;
                }
            });
        }

        // Increment value
        function incrementValue(inputId, step) {
            const input = document.getElementById(inputId);
            const currentValue = parseFloat(input.value) || 0;
            const maxValue = parseFloat(input.max);
            const newValue = currentValue + step;
            
            if (newValue <= maxValue) {
                input.value = newValue;
            }
        }

        // Decrement value
        function decrementValue(inputId, step) {
            const input = document.getElementById(inputId);
            const currentValue = parseFloat(input.value) || 0;
            const minValue = parseFloat(input.min);
            const newValue = currentValue - step;
            
            if (newValue >= minValue) {
                input.value = newValue;
            }
        }

        // Show muscle groups when exercise is selected
        function showMuscleGroups(selectElement, index) {
            const exerciseId = parseInt(selectElement.value);
            const container = document.getElementById(`muscleGroups-${index}`);
            
            if (!exerciseId) {
                container.innerHTML = '';
                return;
            }
            
            const exercise = exercisesList.find(e => e.Id === exerciseId);
            if (!exercise || !exercise.MuscleGroups || exercise.MuscleGroups.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            // Sort: primary first, then alphabetically
            const sortedGroups = [...exercise.MuscleGroups].sort((a, b) => {
                if (a.IsPrimary !== b.IsPrimary) return b.IsPrimary ? 1 : -1;
                return a.Name.localeCompare(b.Name);
            });
            
            const badgesHtml = sortedGroups.map(mg => {
                const badgeClass = mg.IsPrimary ? 'badge bg-primary' : 'badge bg-secondary';
                const icon = mg.IsPrimary ? '<i class="fas fa-star me-1"></i>' : '';
                return `<span class="${badgeClass} me-1 mb-1">${icon}${mg.Name}</span>`;
            }).join('');
            
            container.innerHTML = `<div class="d-flex flex-wrap">${badgesHtml}</div>`;
            
            // Animate badges
            setTimeout(() => {
                container.querySelectorAll('.badge').forEach((badge, i) => {
                    badge.style.opacity = '0';
                    badge.style.transform = 'scale(0.8)';
                    setTimeout(() => {
                        badge.style.transition = 'all 0.3s ease';
                        badge.style.opacity = '1';
                        badge.style.transform = 'scale(1)';
                    }, i * 50);
                });
            }, 10);
        }

        // Set rest time unit for plan exercises (seconds or minutes)
        function setRestUnitPlan(index, isMinutes) {
            const restInMinutesInput = document.getElementById(`restInMinutes-${index}`);
            const restUnitSeg = document.getElementById(`restUnitSeg-${index}`);
            const restUnitMin = document.getElementById(`restUnitMin-${index}`);
            const restTimeInput = document.getElementById(`rest-${index}`);
            
            if (!restInMinutesInput || !restUnitSeg || !restUnitMin || !restTimeInput) return;
            
            const currentIsMinutes = restInMinutesInput.value === 'true';
            
            // If already in the desired unit, do nothing
            if (currentIsMinutes === isMinutes) return;
            
            const currentValue = parseInt(restTimeInput.value) || 0;
            
            if (isMinutes) {
                // Convert from seconds to minutes
                restInMinutesInput.value = 'true';
                restTimeInput.value = Math.round(currentValue / 60);
                restTimeInput.step = 1;
                restUnitSeg.classList.remove('active');
                restUnitMin.classList.add('active');
            } else {
                // Convert from minutes to seconds
                restInMinutesInput.value = 'false';
                restTimeInput.value = currentValue * 60;
                restTimeInput.step = 15;
                restUnitMin.classList.remove('active');
                restUnitSeg.classList.add('active');
            }
        }

        // Increment rest time value
        function incrementRestValue(index) {
            const restTimeInput = document.getElementById(`rest-${index}`);
            const restInMinutesInput = document.getElementById(`restInMinutes-${index}`);
            
            if (!restTimeInput || !restInMinutesInput) return;
            
            const isMinutes = restInMinutesInput.value === 'true';
            const step = isMinutes ? 1 : 15;
            const currentValue = parseInt(restTimeInput.value) || 0;
            const maxValue = parseInt(restTimeInput.max) || 3600;
            const newValue = Math.min(currentValue + step, maxValue);
            
            restTimeInput.value = newValue;
        }

        // Decrement rest time value
        function decrementRestValue(index) {
            const restTimeInput = document.getElementById(`rest-${index}`);
            const restInMinutesInput = document.getElementById(`restInMinutes-${index}`);
            
            if (!restTimeInput || !restInMinutesInput) return;
            
            const isMinutes = restInMinutesInput.value === 'true';
            const step = isMinutes ? 1 : 15;
            const currentValue = parseInt(restTimeInput.value) || 0;
            const minValue = parseInt(restTimeInput.min) || 0;
            const newValue = Math.max(currentValue - step, minValue);
            
            restTimeInput.value = newValue;
        }
    </script>
}
