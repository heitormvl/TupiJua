@model TupiJua.Models.WorkoutSession

@{
    ViewData["Title"] = "Detalhes do Treino";
    var totalExercises = Model.LoggedExercises.Count;
    var totalSets = Model.LoggedExercises.Sum(le => le.Sets);
    var totalVolume = Model.LoggedExercises.Sum(le => le.Weight * le.Sets * le.IntegerReps);
    var muscleGroups = Model.LoggedExercises
        .SelectMany(le => le.Exercise.ExerciseMuscleGroups.Select(emg => emg.MuscleGroup.Name))
        .Distinct()
        .ToList();
}

@functions {
    string FormatVolume(decimal volume)
    {
        return volume % 1 == 0 ? volume.ToString("N0") : volume.ToString("N2");
    }

    string FormatWeight(decimal weight)
    {
        return weight % 1 == 0 ? weight.ToString("N0") : weight.ToString("N2");
    }
}

<div class="container-fluid px-3 px-md-4 py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Header Card -->
            <div class="hero-card mb-4">
                <div class="hero-content">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div>
                            <h2 class="hero-title mb-2">
                                <i class="fas fa-dumbbell me-2"></i>
                                @if (Model.WorkoutPlan != null)
                                {
                                    <span>@Model.WorkoutPlan.Name</span>
                                }
                                else
                                {
                                    <span>Treino Livre</span>
                                }
                            </h2>
                            <p class="hero-subtitle mb-0">
                                <i class="fas fa-calendar me-2"></i>
                                @Model.Date.ToString("dd 'de' MMMM 'de' yyyy", new System.Globalization.CultureInfo("pt-BR"))
                                às @Model.Date.ToString("HH:mm")
                            </p>
                        </div>
                        <div>
                            @if (Model.IsCompleted)
                            {
                                <span class="badge bg-success" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Concluído
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-warning text-dark" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                    <i class="fas fa-clock me-2"></i>
                                    Em andamento
                                </span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Summary -->
            <div class="row g-3 mb-4">
                <div class="col-12 col-md-3">
                    <div class="stat-card stat-card-1">
                        <div class="stat-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">@totalExercises</div>
                            <div class="stat-label">Exercício@(totalExercises != 1 ? "s" : "")</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="stat-card stat-card-2">
                        <div class="stat-icon">
                            <i class="fas fa-redo"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">@totalSets</div>
                            <div class="stat-label">Série@(totalSets != 1 ? "s" : "")</div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="stat-card stat-card-3">
                        <div class="stat-icon">
                            <i class="fas fa-weight-hanging"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value">@FormatVolume(totalVolume)</div>
                            <div class="stat-label">Volume (kg)</div>
                        </div>
                    </div>
                </div>
                @if (Model.TotalDurationMinutes.HasValue)
                {
                    <div class="col-12 col-md-3">
                        <div class="stat-card stat-card-1">
                            <div class="stat-icon">
                                <i class="fas fa-stopwatch"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">@Model.TotalDurationMinutes</div>
                                <div class="stat-label">Minutos</div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <!-- Muscle Groups -->
            @if (muscleGroups.Any())
            {
                <div class="workout-plans-card mb-4">
                    <h5 class="mb-3">
                        <i class="fas fa-bullseye me-2"></i>
                        Grupos Musculares Trabalhados
                    </h5>
                    <div class="d-flex flex-wrap gap-2">
                        @foreach (var muscle in muscleGroups)
                        {
                            <span class="badge bg-primary" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                                @muscle
                            </span>
                        }
                    </div>
                </div>
            }

            <!-- Exercises List -->
            <div class="workout-plans-card mb-4">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Exercícios Realizados
                    </h5>
                    @if (!Model.IsCompleted)
                    {
                        <div class="d-flex gap-2">
                            <a asp-action="AddExercise" asp-route-sessionId="@Model.Id" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus me-1"></i>
                                Adicionar Exercício
                            </a>
                            <form asp-action="FinishWorkout" asp-route-sessionId="@Model.Id" method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-success">
                                    <i class="fas fa-check me-1"></i>
                                    Finalizar Treino
                                </button>
                            </form>
                        </div>
                    }
                </div>

                @if (Model.LoggedExercises.Any())
                {
                    <div class="exercises-list">
                        @foreach (var loggedExercise in Model.LoggedExercises)
                        {
                            <div class="exercise-detail-card mb-3">
                                <div class="exercise-detail-header">
                                    <div class="d-flex align-items-start justify-content-between">
                                        <div class="flex-grow-1">
                                            <h5 class="exercise-detail-name mb-2">
                                                <i class="fas fa-dumbbell me-2 text-primary"></i>
                                                @loggedExercise.Exercise.Name
                                            </h5>
                                            @if (loggedExercise.Exercise.ExerciseMuscleGroups.Any())
                                            {
                                                <div class="exercise-muscles mb-2">
                                                    @foreach (var emg in loggedExercise.Exercise.ExerciseMuscleGroups)
                                                    {
                                                        <span class="badge bg-light text-dark me-1">
                                                            @emg.MuscleGroup.Name
                                                        </span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        @if (loggedExercise.ShouldIncreaseLoad)
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-arrow-up me-1"></i>
                                                Aumentar carga
                                            </span>
                                        }
                                    </div>
                                </div>

                                <div class="exercise-detail-body">
                                    <div class="row g-3">
                                        <div class="col-6 col-md-3">
                                            <div class="detail-item">
                                                <div class="detail-label">
                                                    <i class="fas fa-redo me-1"></i>
                                                    Séries
                                                </div>
                                                <div class="detail-value">@loggedExercise.Sets</div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="detail-item">
                                                <div class="detail-label">
                                                    <i class="fas fa-hashtag me-1"></i>
                                                    Repetições
                                                </div>
                                                <div class="detail-value">@loggedExercise.Reps</div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="detail-item">
                                                <div class="detail-label">
                                                    <i class="fas fa-weight-hanging me-1"></i>
                                                    Carga
                                                </div>
                                                <div class="detail-value">@FormatWeight(loggedExercise.Weight) kg</div>
                                            </div>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <div class="detail-item">
                                                <div class="detail-label">
                                                    <i class="fas fa-stopwatch me-1"></i>
                                                    Descanso
                                                </div>
                                                <div class="detail-value">@loggedExercise.RestTime @(loggedExercise.RestInMinutes ? "min" : "seg")</div>
                                            </div>
                                        </div>
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(loggedExercise.Observation))
                                    {
                                        <div class="mt-3 pt-3 border-top">
                                            <div class="detail-label mb-2">
                                                <i class="fas fa-comment me-1"></i>
                                                Observações
                                            </div>
                                            <p class="mb-0 text-muted">@loggedExercise.Observation</p>
                                        </div>
                                    }

                                    <div class="mt-3 pt-3 border-top">
                                        <div class="text-muted small">
                                            <i class="fas fa-calculator me-1"></i>
                                            Volume: <strong>@FormatVolume(loggedExercise.Weight * loggedExercise.Sets * loggedExercise.IntegerReps) kg</strong>
                                        </div>
                                    </div>

                                    @if (!Model.IsCompleted)
                                    {
                                        <div class="mt-3 pt-3 border-top">
                                            <div class="d-flex gap-2">
                                                <a asp-action="EditLoggedExercise" asp-route-id="@loggedExercise.Id" class="btn btn-sm btn-outline-primary flex-fill">
                                                    <i class="fas fa-edit me-1"></i>
                                                    Editar
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger flex-fill" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteLoggedExerciseModal"
                                                        data-id="@loggedExercise.Id"
                                                        data-name="@loggedExercise.Exercise.Name">
                                                    <i class="fas fa-trash me-1"></i>
                                                    Excluir
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h5>Nenhum exercício registrado</h5>
                        <p>Adicione exercícios para começar seu treino!</p>
                    </div>
                }
            </div>

            <!-- Action Buttons -->
            <div class="d-flex justify-content-between gap-2">
                <a asp-action="Index" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Voltar
                </a>
                @if (!Model.IsCompleted && Model.LoggedExercises.Any())
                {
                    <form asp-action="FinishWorkout" asp-route-sessionId="@Model.Id" method="post" class="d-inline">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-check me-2"></i>
                            Finalizar Treino
                        </button>
                    </form>
                }
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteLoggedExerciseModal" tabindex="-1" aria-labelledby="deleteLoggedExerciseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title" id="deleteLoggedExerciseModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Tem certeza que deseja excluir o exercício:</p>
                <p class="fw-bold mb-3" id="exerciseNameToDelete"></p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <small><strong>Atenção:</strong> Esta ação não pode ser desfeita!</small>
                </div>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <form id="deleteLoggedExerciseForm" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        Excluir
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Handle delete modal
        const deleteModal = document.getElementById('deleteLoggedExerciseModal');
        if (deleteModal) {
            deleteModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const id = button.getAttribute('data-id');
                const name = button.getAttribute('data-name');
                
                const form = document.getElementById('deleteLoggedExerciseForm');
                const nameDisplay = document.getElementById('exerciseNameToDelete');
                
                form.action = '@Url.Action("DeleteLoggedExercise", "Training")/' + id;
                nameDisplay.textContent = name;
            });
        }
    </script>
}
