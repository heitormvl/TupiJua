@model TupiJua.ViewModels.LogExerciseViewModel

@{
    ViewData["Title"] = "Adicionar Exercício";
    var exercises = ViewBag.Exercises as List<TupiJua.Models.Exercise> ?? new List<TupiJua.Models.Exercise>();
    var fromPlan = ViewBag.FromPlan as bool? ?? false;
    var exercise = ViewBag.Exercise as TupiJua.Models.Exercise;
    var targetSets = ViewBag.TargetSets as int? ?? 0;
    var targetReps = ViewBag.TargetReps as string;
    var recommendedRestTime = ViewBag.RecommendedRestTime as int? ?? 0;
    var restInMinutes = ViewBag.RestInMinutes as bool? ?? false;
    var hasLastExecution = ViewBag.HasLastExecution as bool? ?? false;
    var lastSets = ViewBag.LastSets as int? ?? 0;
    var lastReps = ViewBag.LastReps as string;
    var lastWeight = ViewBag.LastWeight as decimal? ?? 0;
    var lastRestTime = ViewBag.LastRestTime as int? ?? 0;
    var lastRestInMinutes = ViewBag.LastRestInMinutes as bool? ?? false;
}

<div class="container-fluid px-3 px-md-4 py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-8">
            <!-- Header Card -->
            <div class="exercise-header-card mb-4">
                <h2 class="mb-2">
                    <i class="fas fa-plus-circle me-2"></i>
                    Adicionar Exercício
                </h2>
                <p class="text-muted mb-0">Registre os detalhes do seu exercício</p>
            </div>

            @if (fromPlan && exercise != null)
            {
                @if (hasLastExecution)
                {
                    <!-- Comparação: Meta do Plano vs Última Execução -->
                    <div class="last-exercise-card mb-4" id="planComparisonCard">
                        <h6 class="mb-3 text-center">
                            <i class="fas fa-bullseye text-primary me-2"></i>
                            Meta do Plano
                            <span class="mx-2">+</span>
                            <i class="fas fa-history text-success me-2"></i>
                            Última Execução
                        </h6>
                        <div class="row g-3 card-minimize-content" id="planComparisonCard-content">
                            <!-- Séries -->
                            <div class="col-6 col-md-3">
                                <div class="last-exercise-stat text-center">
                                    <small class="text-muted d-block mb-1">Séries</small>
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <strong class="text-primary">@targetSets</strong>
                                        <span class="text-muted">/</span>
                                        <strong class="text-success">@lastSets</strong>
                                    </div>
                                </div>
                            </div>
                            <!-- Reps -->
                            <div class="col-6 col-md-3">
                                <div class="last-exercise-stat text-center">
                                    <small class="text-muted d-block mb-1">Reps</small>
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <strong class="text-primary">@targetReps</strong>
                                        <span class="text-muted">/</span>
                                        <strong class="text-success">@lastReps</strong>
                                    </div>
                                </div>
                            </div>
                            <!-- Última Carga -->
                            <div class="col-6 col-md-3">
                                <div class="last-exercise-stat text-center">
                                    <small class="text-muted d-block mb-1">Última Carga</small>
                                    <strong class="text-success">@lastWeight kg</strong>
                                </div>
                            </div>
                            <!-- Descanso -->
                            <div class="col-6 col-md-3">
                                <div class="last-exercise-stat text-center">
                                    <small class="text-muted d-block mb-1">Descanso</small>
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <strong class="text-primary">@recommendedRestTime @(restInMinutes ? "min" : "seg")</strong>
                                        <span class="text-muted">/</span>
                                        <strong class="text-success">@lastRestTime @(lastRestInMinutes ? "min" : "seg")</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <button type="button" class="btn btn-link text-muted p-0" 
                                    onclick="toggleCardMinimize('planComparisonCard')" 
                                    style="text-decoration: none; font-size: 1.25rem; transition: transform 0.3s ease;">
                                <i class="fas fa-chevron-up" id="planComparisonCard-icon"></i>
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Apenas Meta do Plano -->
                    <div class="last-exercise-card mb-4">
                        <h6 class="mb-3 text-center">
                            <i class="fas fa-bullseye text-primary me-2"></i>
                            Meta do Plano
                        </h6>
                        <div class="row g-3">
                            <div class="col-6 col-md-4">
                                <div class="last-exercise-stat text-center">
                                    <small class="text-muted">Séries</small>
                                    <strong class="text-primary">@targetSets</strong>
                                </div>
                            </div>
                            <div class="col-6 col-md-4">
                                <div class="last-exercise-stat text-center">
                                    <small class="text-muted">Reps</small>
                                    <strong class="text-primary">@targetReps</strong>
                                </div>
                            </div>
                            @if (recommendedRestTime > 0)
                            {
                                <div class="col-6 col-md-4">
                                    <div class="last-exercise-stat text-center">
                                        <small class="text-muted">Descanso</small>
                                        <strong class="text-primary">@recommendedRestTime @(restInMinutes ? "min" : "seg")</strong>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Primeira vez fazendo este exercício
                            </small>
                        </div>
                    </div>
                }
            }

            <!-- Last Exercise Info (will be populated by JS) -->
            <div id="lastExerciseInfo" class="last-exercise-card mb-4" style="display: none;">
                <h6 class="mb-3 text-center">
                    <i class="fas fa-history text-success me-2"></i>
                    Última vez que fez este exercício
                </h6>
                <div id="lastExerciseData" class="last-exercise-data card-minimize-content"></div>
                <div class="text-center mt-2">
                    <button type="button" class="btn btn-link text-muted p-0" 
                            onclick="toggleCardMinimize('lastExerciseInfo')" 
                            style="text-decoration: none; font-size: 1.25rem; transition: transform 0.3s ease;">
                        <i class="fas fa-chevron-up" id="lastExerciseInfo-icon"></i>
                    </button>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="exercise-form-card">
                <form asp-action="@(fromPlan ? "AddExerciseFromPlan" : "AddExercise")" method="post" id="exerciseForm">
                    <input type="hidden" asp-for="WorkoutSessionId" />

                    @if (fromPlan)
                    {
                        <!-- Exercise is pre-selected, show as readonly -->
                        <input type="hidden" asp-for="ExerciseId" />
                        <div class="form-section">
                            <label class="form-label">
                                <i class="fas fa-dumbbell me-2"></i>
                                Exercício
                            </label>
                            <input type="text" class="form-control form-control-lg" value="@exercise?.Name" readonly />
                        </div>
                    }
                    else
                    {
                        <!-- Exercise Selection -->
                        <div class="form-section">
                            <label class="form-label">
                                <i class="fas fa-dumbbell me-2"></i>
                                Exercício
                            </label>
                            <select asp-for="ExerciseId" class="form-select form-select-lg" id="exerciseSelect" required>
                                <option value="">Selecione um exercício</option>
                                @{
                                    var exercisesByCategory = exercises
                                        .GroupBy(e => e.ExerciseMuscleGroups
                                            .Where(emg => emg.IsPrimary)
                                            .Select(emg => emg.MuscleGroup.Name)
                                            .FirstOrDefault() ?? "Sem Categoria")
                                        .OrderBy(g => g.Key)
                                        .ToList();

                                    foreach (var category in exercisesByCategory)
                                    {
                                        <optgroup label="@category.Key">
                                            @foreach (var ex in category.OrderBy(e => e.Name))
                                            {
                                                <option value="@ex.Id">@ex.Name</option>
                                            }
                                        </optgroup>
                                    }
                                }
                            </select>
                            <span asp-validation-for="ExerciseId" class="text-danger small"></span>
                        </div>
                    }

                    <!-- Sets -->
                    <div class="form-section">
                        <label class="form-label">
                            <i class="fas fa-redo me-2"></i>
                            Séries
                        </label>
                        <div class="number-input-group">
                            <button type="button" class="btn-number-control" onclick="decrementValue('Sets', 1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input asp-for="Sets" type="number" class="form-control form-control-lg text-center" 
                                   id="Sets" min="1" max="100" placeholder="3" required />
                            <button type="button" class="btn-number-control" onclick="incrementValue('Sets', 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <span asp-validation-for="Sets" class="text-danger small"></span>
                    </div>

                    <!-- Reps -->
                    <div class="form-section">
                        <label class="form-label">
                            <i class="fas fa-hashtag me-2"></i>
                            Repetições
                        </label>
                        <div class="input-group input-group-lg">
                            <input asp-for="Reps" type="text" class="form-control" 
                                   placeholder="10-15" id="Reps" required />
                            <span class="input-group-text">reps</span>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Digite um número (ex: 12) ou uma faixa (ex: 10-12)
                        </small>
                        <span asp-validation-for="Reps" class="text-danger small d-block"></span>
                    </div>

                    <!-- Weight -->
                    <div class="form-section">
                        <label class="form-label">
                            <i class="fas fa-weight-hanging me-2"></i>
                            Carga
                        </label>
                        <div class="number-input-group">
                            <button type="button" class="btn-number-control" onclick="decrementValue('Weight', 0.5)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input asp-for="Weight" type="number" class="form-control form-control-lg text-center" 
                                   id="Weight" min="0" max="999.99" step="0.01" placeholder="10" required />
                            <button type="button" class="btn-number-control" onclick="incrementValue('Weight', 0.5)">
                                <i class="fas fa-plus"></i>
                            </button>
                            <span class="input-group-text-addon">kg</span>
                        </div>
                        <span asp-validation-for="Weight" class="text-danger small"></span>
                    </div>

                    <!-- Rest Time -->
                    <div class="form-section">
                        <label class="form-label">
                            <i class="fas fa-stopwatch me-2"></i>
                            Descanso entre séries
                        </label>
                        <div class="number-input-group">
                            <button type="button" class="btn-number-control" onclick="decrementRestTime()">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input asp-for="RestTime" type="number" class="form-control form-control-lg text-center" 
                                   id="RestTime" min="0" max="3600" step="@(restInMinutes ? "1" : "15")" placeholder="60" required />
                            <button type="button" class="btn-number-control" onclick="incrementRestTime()">
                                <i class="fas fa-plus"></i>
                            </button>
                            <div class="input-group-text-addon" style="padding: 0; border: none; background: transparent;">
                                <div class="btn-group btn-group-sm" role="group" style="box-shadow: none;">
                                    <button type="button" class="btn btn-outline-primary active" id="restUnitSeg" onclick="setRestUnit(false)" style="border-radius: 0.25rem 0 0 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                        seg
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" id="restUnitMin" onclick="setRestUnit(true)" style="border-radius: 0 0.25rem 0.25rem 0; padding: 0.25rem 0.5rem; font-size: 0.875rem;">
                                        min
                                    </button>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" asp-for="RestInMinutes" id="RestInMinutes" />
                        <span asp-validation-for="RestTime" class="text-danger small"></span>
                    </div>

                    <!-- Progress Flag -->
                    <div class="form-section">
                        <div class="progress-flag-card">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <label class="form-label mb-1">
                                        <i class="fas fa-arrow-up me-2"></i>
                                        Aumentar dificuldade no próximo?
                                    </label>
                                    <p class="small text-muted mb-0">
                                        Ao marcar essa opção, será exibido um lembrete no próximo treino deste exercício, além de sugerir o aumento de carga em 5%
                                    </p>
                                </div>
                                <div class="form-check form-switch">
                                    <input asp-for="ShouldIncreaseLoad" class="form-check-input" type="checkbox" 
                                           role="switch" id="ShouldIncreaseLoad" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observation -->
                    <div class="form-section">
                        <label class="form-label">
                            <i class="fas fa-sticky-note me-2"></i>
                            Observações (opcional)
                        </label>
                        <textarea asp-for="Observation" class="form-control" rows="3" 
                                  placeholder="Ex: Senti um pouco de dor no ombro direito..." 
                                  maxlength="1000"></textarea>
                        <span asp-validation-for="Observation" class="text-danger small"></span>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-actions">
                        @if (fromPlan)
                        {
                            <button type="submit" name="action" value="finish" class="btn btn-success btn-lg">
                                <i class="fas fa-check-circle me-2"></i>
                                Salvar e Voltar ao Plano
                            </button>
                        }
                        else
                        {
                            <button type="submit" name="action" value="continue" class="btn btn-success btn-lg">
                                <i class="fas fa-plus-circle me-2"></i>
                                Salvar e Adicionar Próximo
                            </button>
                            <button type="submit" name="action" value="finish" class="btn btn-primary btn-lg">
                                <i class="fas fa-check-circle me-2"></i>
                                Salvar e Voltar
                            </button>
                        }
                    </div>
                </form>
            </div>

            <!-- Quick Tips Card -->
            <div class="tips-card mt-4">
                <h6 class="mb-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    Dicas Rápidas
                </h6>
                <ul class="tips-list">
                    <li><i class="fas fa-check text-success me-2"></i>Use os botões <strong>+ / -</strong> para ajustes rápidos</li>
                    <li><i class="fas fa-check text-success me-2"></i>Marque "Aumentar dificuldade" quando sentir que está fácil</li>
                    <li><i class="fas fa-check text-success me-2"></i>Adicione observações importantes sobre forma ou sensações</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/training.js"></script>
    <style>
        .card-minimize-content {
            transition: opacity 0.3s ease, max-height 0.3s ease, margin 0.3s ease;
            overflow: hidden;
            opacity: 1;
        }
        
        .card-minimize-content.minimized {
            max-height: 0 !important;
            opacity: 0;
            margin: 0 !important;
            padding: 0 !important;
        }
    </style>
}
